name: Run tests
on:
  push:
    branches: [ twine-cond ]
  pull_request:
    branches: [ master ]
jobs:
    test:
      runs-on: ubuntu-latest
      strategy:
        matrix:
          python: [2.7, 3.6, 3.7, 3.8, 3.9]
      steps:
        - uses: actions/checkout@v2
        - name: Setup Python
          uses: actions/setup-python@v2
          with:
            python-version: ${{ matrix.python }}
        - name: Install Tox and any other packages
          run: |
            python -m pip install --upgrade pip
            pip install tox tox-gh-actions
        - name: Run Tox
          # Run tox using the version of Python in `PATH`
          run: tox -epy
    flake8:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
        - name: Setup Python
          uses: actions/setup-python@v2
          with:
            python-version: 3.9
        - name: Install Tox and any other packages
          run: |
            python -m pip install --upgrade pip
            pip install tox tox-gh-actions
        - name: Lint with flake8
          run: tox -eflake8
    integration:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
        - name: Setup Python
          uses: actions/setup-python@v2
          with:
            python-version: 3.9
        - name: Install Tox and any other packages
          run: |
            python -m pip install --upgrade pip
            pip install tox tox-gh-actions
        - name: Run integration tests
          run: tox -eintegration
    changedfiles:
      runs-on: ubuntu-latest
      outputs:
        # all files and rst files changed
        all: ${{ steps.changes.outputs.all }}
        rst: ${{ steps.changes.outputs.rst }}
      steps:
        - name: Checkout repository
          uses: actions/checkout@v2
          with:
            # necessary to work with amended commits
            fetch-depth: 2
        - name: Get changed files
          id: changes
          run: |
            echo "::set-output name=rst::$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep .rst$ )"
            echo "::set-output name=all::$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})"
            echo "$all"
            echo "$rst"
    twine:
      runs-on: ubuntu-latest
      # requires previous job to run first
      needs: changedfiles
      # if only there are changed .rst files
      if: ${{ needs.changedfiles.outputs.rst }}
      steps:
        - uses: actions/checkout@v2
        - name: Setup Python
          uses: actions/setup-python@v2
          with:
            python-version: 3.9
        - name: Install Tox and any other packages
          run: |
            python -m pip install --upgrade pip
            pip install tox tox-gh-actions
        - name: Run twine-check
          run: |
            tox -etwine
